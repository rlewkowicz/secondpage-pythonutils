/* amazon-dtb-javascript-api - v7.2.2 - 2018-05-15 11:01:28 PM */"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},_extends=Object.assign||function(a){var b,c,d;for(b=1;b<arguments.length;b++){c=arguments[b];for(d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a};!function(){function _shouldSample(a){var b,c;try{if(b=parseInt(a,10),!isNaN(b)){if(0===b)return!1;if(100===b)return!0;if(c=100*Math.random(),b>=c)return!0}return!1}catch(d){return _reportError(d,"__error-shouldSampleLatency__"),!1}}function _reportError(a,b,c,d,e,f){var g,h,i;try{if(!SHOULD_SAMPLE_ERRORS)return;g={lv:LIBRARY_VERSION,ts:Date.now(),url:encodeURIComponent(window.document.documentURI),r:encodeURIComponent(window.document.referrer),_type:"apstagError",e:{et:a.name,el:b,msg:encodeURIComponent(a.message)}},"undefined"!=typeof c&&(c?(g.src=d,g.pubid=e):g.src=e),f=f||document.location.protocol+"//aax.amazon-adsystem.com/x/px/",h=encodeURIComponent(JSON.stringify(g)),i=f+"p/PH/"+h,i&&((new Image).src=i)}catch(j){}}function _safeWindowHasOwnProperty(a){return Object.prototype.hasOwnProperty.call(window,a)}function _safeObjectHasProperty(a,b){return a.hasOwnProperty(b)&&"undefined"!=typeof a[b]&&""!==a[b]}function TestSuite(a,b,c,d){var e,f,g,h=this;return this.testId=a.getRand(),d.sample="undefined"==typeof d.sample?1:d.sample,d.delay="undefined"==typeof d.delay?5e3:d.delay,e=function(){g("setup"),h.runningCase=a.getRandomArrayElement(Object.keys(d.cases)),g("running"),d.run(f,d.cases[h.runningCase])},f=function(a){g("pixeling"),a._type=encodeURIComponent(d.name+"-tst"),Object.keys(d.cases).length>1&&(a._case=encodeURIComponent(h.runningCase)),b.noBidCacheIDPixel(a),g("done")},g=function(a){h.status=a,c.dispatch({type:"UPDATE_TEST",id:h.testId,status:h.status,name:h.name,"case":h.runningCase})},this.name=d.name,this.sampleRate=d.sample,this.runningCase="",this.status="",g("config"),a.shouldSample(d.sample)?(g("waiting"),void setTimeout(e,d.delay)):void g("nosample")}var HAS_LIBRARY_LOADED,LIBRARY_VERSION="7.2.2",SHOULD_SAMPLE_ERRORS=_shouldSample(10);try{HAS_LIBRARY_LOADED=function(){var a=!1;return _safeWindowHasOwnProperty("apstag")&&window.apstag.hasOwnProperty("debug")&&(a=!0),a}(),HAS_LIBRARY_LOADED||!function(){function _debugProp(a){var b;return _safeWindowHasOwnProperty(DEBUG_GLOBAL)&&window[DEBUG_GLOBAL].hasOwnProperty(a)&&(b=window[DEBUG_GLOBAL][a]),b}function _getProtocol(){var a=document.location.protocol;return"h"===a[0]?a+"//":"https://"}function _aaxHost(){var a=DEFAULT_AAX_HOST;return _debugProp("host")&&(a=window[DEBUG_GLOBAL].host),a}function _detectIframeAndGetURL(){try{return window.top!==window.self?encodeURIComponent(document.referrer):""}catch(a){return _reportErrorSimple(a,"__error-detectIframeAndGetURL__"),encodeURIComponent(document.documentURI)}}function _getPageReferrerURL(){var a,b;try{try{b=window.top.document.referrer}catch(c){_reportErrorSimple(c,"__error-getPageReferrerURL-1__"),b=window.document.referrer}a=encodeURIComponent(b)}catch(c){_reportErrorSimple(c,"__error-getPageReferrerURL-2__")}return a}function _getReferrerURL(){var a,b;if(_debugProp("url"))return a=window[DEBUG_GLOBAL].url,encodeURIComponent(a);b=encodeURIComponent(document.documentURI);try{b=encodeURIComponent(window.top.location.href),b&&"undefined"!=typeof b||(b=_detectIframeAndGetURL())}catch(c){_reportErrorSimple(c,"__error-getReferrerURL__"),b=_detectIframeAndGetURL()}return b}function _getCfgVersion(){return lsPresent?state.hasOwnProperty("cfg")&&state.cfg.hasOwnProperty("v")?state.cfg.v:null:NO_LOCAL_STORAGE_SUPPORT_MAGIC_NUNMBER_FOR_AAX}function _pixel(a){a&&((new Image).src=a)}function _pixelBaseURL(){return""+PROTOCOL+_aaxHost()+PIXEL_PATH}function _objToURLParam(a){return encodeURIComponent(JSON.stringify(a))}function _safeDebugSet(a){lsPresent&&window.localStorage.setItem(DEBUG_LOCAL_STORAGE_KEY,a)}function _debugConsole(a){lsPresent&&window.localStorage.setItem(DEBUG_CONSOLE_LOCAL_STORAGE_KEY,a)}function _logEvent(a){a.ts=Date.now(),dispatch({type:"LOG_EVENT",event:a})}function _doCookieMatch(a){function b(a){if(!state.cmpFired){dispatch({type:"CMP_FIRED"});var b=document.createElement("iframe");b.style.display="none",b.src=a,document.body.appendChild(b)}}document.readyState&&"loading"===document.readyState?document.addEventListener?document.addEventListener("DOMContentLoaded",function(){b(a)},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&b(a)}):b(a)}function _doJSCookieMatch(a){_loadScriptTag(a)}function _tryCookieMatch(a){try{var b=state.cfg.COOKIE_MATCH_DELAY||COOKIE_MATCH_DELAY;window.setTimeout(function(){try{a&&a.cmp&&""!==a.cmp&&"undefined"!=typeof a.cmp?_doCookieMatch(a.cmp):a&&a.cmpjs&&""!==a.cmpjs&&"undefined"!=typeof a.cmpjs&&_doJSCookieMatch(a.cmpjs)}catch(b){_reportErrorSimple(b,"__error-tryCookieMatch-1__")}},b)}catch(c){_reportErrorSimple(c,"__error-tryCookieMatch-2__")}}function _getValidMilliseconds(a){if(!a)return!1;try{var b=~~Number(a);if(b>MINIMUM_BID_TIMEOUT)return b}catch(c){return _reportErrorSimple(c,"__error-getValidMilliseconds__"),!1}return!1}function _safeOnload(a,b,c){try{b&&"function"==typeof b&&(a.readyState?a.onreadystatechange=function(){("loaded"===a.readyState||"complete"===a.readyState)&&(a.onreadystatechange=null,b.apply(null,c))}:a.onload=function(){b.apply(null,c)})}catch(d){_reportErrorSimple(d,"__error-safeOnload__")}}function _isRequestComplete(a){return!state.experiments.chunkRequests||0===state.bidReqs[a.split("-")[0]].networkReqs.filter(function(a){return a.inFlight}).length}function _checkAndCallCallback(a,b){!state.bidReqs[a[0]].hasCallbackExecuted&&_isRequestComplete(a[0])&&(dispatch({type:"RECORD_CALLBACK",fid:a[0]}),b())}function _recordResponse(a){state.experiments.chunkRequests&&dispatch({type:"RECORD_NETWORK_EXCHANGE",fid:a[0],timestamp:Date.now(),exchangeType:"response",networkID:a[1]})}function _xhrGetRequest(a){try{var b=new XMLHttpRequest;b.onload=a.onload.bind(null,b),b.onerror=a.onerror,a.withCredentials&&(b.withCredentials=!0),b.open("GET",a.url),b.send(null)}catch(c){_reportErrorSimple(c,"__error-xhr__")}}function _xhrBid(url,callback,fid){var fidData=fid.split("-"),xhrConfig={url:url,withCredentials:!0};try{xhrConfig.onload=function(xhr){_recordResponse(fidData),eval(xhr.responseText),_checkAndCallCallback(fidData,callback)},xhrConfig.onerror=function(){_recordResponse(fidData),_checkAndCallCallback(fidData,callback)},_xhrGetRequest(xhrConfig)}catch(e){_reportErrorSimple(e,"__error-xhrBid__"),_recordResponse(fidData),_checkAndCallCallback(fidData,callback)}}function _loadScriptTag(a,b,c){var d,e;return c||(c=document),!a&&b&&"function"==typeof b?void b(!0):(d=c.getElementsByTagName("script")[0],e=c.createElement("script"),e.type="text/javascript",e.async=!0,e.src=a,b&&_safeOnload(e,b),void d.parentNode.insertBefore(e,d))}function _getWindowsPerformanceTiming(a){try{if(HAS_PERFORMANCE_SUPPORT)return performance.timing[a]}catch(b){_reportErrorSimple(b,"__error-getWindowsPerformanceTiming__")}return 0}function _getPerformanceObject(a){try{return HAS_PERFORMANCE_SUPPORT?performance.getEntriesByType("resource").filter(function(b){return b.name.indexOf(a)>-1})[0]:null}catch(b){return _reportErrorSimple(b,"__error-getPerformanceObject__"),null}}function _getPerfObjectTSFromMSMeasurement(a,b){try{return a&&b in a?parseInt(a[b]+NAV_START,10):0}catch(c){return _reportErrorSimple(c,"__error-getPerfObjectTSFromMSMeasurement__"),0}}function _getFetchStart(a){return _getPerfObjectTSFromMSMeasurement(a,"fetchStart")}function _getResponseEnd(a){return _getPerfObjectTSFromMSMeasurement(a,"responseEnd")}function _getFirstPartyCookies(){var a,b,c=document.cookie.split("; ");return c.forEach(function(c){b=c.split("="),b[0]in FIRST_PARTY_COOKIE_KEYS&&(a+="&"+FIRST_PARTY_COOKIE_KEYS[b[0]].urlParam+"="+b[1])}),a}function _getCookieExpiry(a){var b=new Date;return b.setTime(b.getTime()+1e3*a),b.toGMTString()}function _setFirstPartyCookies(a){if(a[AAX_RESP_REMAP_COOKIE_KEY])try{a[AAX_RESP_REMAP_COOKIE_KEY].forEach(function(a){document.cookie=a.k+"="+a.v+";expires="+_getCookieExpiry(a.exp)+";"})}catch(b){_reportErrorSimple(b,"__error-setFirstPartyCookies__")}}function _doOnAAXResponse(a){a.hasOwnProperty("cb")&&dispatch({type:"RECORD_AAX_RESPONSE_PROP",bidReqID:a.cb,key:"resTs",value:Date.now()}),a.hasOwnProperty("cfg")&&dispatch({type:"SET_CFG",cfg:a.cfg}),metrics.addTimer("br"),metrics.set("brs",a.punt?"0":"1"),a.hasOwnProperty("rm")&&metrics.schedule(a.to,a.id),_isGoogletagDisplayAdServer()&&_determineNoBidStateForDFP(a)}function _doAfterAAXResponse(a){_tryCookieMatch(a),_setFirstPartyCookies(a),a.hasOwnProperty("cfg")&&localStorage.setItem(CFG_LOCAL_STORAGE_KEY,JSON.stringify(a.cfg))}function _wrapCallback(a,b){var c=!1,d=null,e=function(b){if(!c){try{a(b),d&&clearTimeout(d)}catch(e){_reportErrorSimple(e,"__error-wrapCallback__")}c=!0}},f=_getValidMilliseconds(b);return d=window.setTimeout(e.bind(null,!0),f||DEFAULT_TIMEOUT),e.bind(null,!1)}function _getRnd(){var a=Math.round(1e12*Math.random());return""+a+Date.now()}function _getWindowDimensions(){var a,b;try{return a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,b=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,a+"x"+b}catch(c){_reportErrorSimple(c,"__error-getWindowsDimensions__")}return"x"}function _mapSlotsArgToURLParam(a){var b=a.map(function(a){if(a.hasOwnProperty("mediaType")&&"video"===a.mediaType)return{id:a.slotID,mt:MEDIA_TYPES_MAGIC_STRING_FOR_AAX.video};if(a.hasOwnProperty("sizes")){var b={sd:a.slotID,s:a.sizes.filter(function(a){return _isArray(a)}).map(function(a){return a.join("x")})};return a.hasOwnProperty("slotName")&&a.slotName!==a.slotID&&(b.sn=a.slotName),b}return _extends({},a,{id:"error"})}).filter(function(a){return"error"!==a.id});return _objToURLParam(b)}function _getBlockedBidders(a){var b,c=a.blockedBidders&&_isArray(a.blockedBidders)?a.blockedBidders:state.config.blockedBidders;return c&&_isArray(c)&&(b=JSON.stringify(c)),b}function _bidURL(a,b){var c,d,e,f,g=_aaxHost(),h=DTB_PATH,i=state.config.pubID,j=PAGELOAD_ID,k=_getReferrerURL(),l=_getPageReferrerURL(),m=_getWindowDimensions(),n=LIBRARY_VERSION,o=_getFirstPartyCookies(),p=_getBlockedBidders(a),q=_getCfgVersion();return dispatch({type:"RECORD_AAX_REQUEST",data:{bidConfig:a,timeout:b,bidReqID:a.bidReqID,ws:m,url:k,rqTs:Date.now()}}),state.experiments.chunkRequests&&(e=a.bidReqID.split("-"),dispatch({type:"RECORD_NETWORK_EXCHANGE",fid:e[0],networkID:e[1],timestamp:Date.now(),exchangeType:"request"})),c=state.config.isSelfServPub?"src=600&pubid="+i:"src="+i,c+="&u="+k+"&pid="+j+"&cb="+a.bidReqID+"&ws="+m+"&v="+n+"&t="+b,a.hasOwnProperty("slots")&&(c+="&slots="+_mapSlotsArgToURLParam(a.slots)),(state.config.hasOwnProperty("params")||Object.keys(state.experiments).length>0)&&(d=_extends({},state.config.params,{apse:state.experiments}),c+="&pj="+_objToURLParam(d)),o&&(c+=o),(q||q===NO_LOCAL_STORAGE_SUPPORT_MAGIC_NUNMBER_FOR_AAX)&&(c+="&cfgv="+q),_debugProp("bidParams")&&Object.keys(window[DEBUG_GLOBAL].bidParams).forEach(function(a){c+="&"+a+"="+window[DEBUG_GLOBAL].bidParams[a]}),l&&""!==l&&(c+="&pr="+l),p&&(c+="&bb="+p),"object"!==_typeof(state.config.gdpr)||_isArray(state.config.gdpr)||(state.config.gdpr.enabled===!1?c+="&gdpre=0":(c+=Number.isInteger(state.config.gdpr.enabled)?"&gdpre="+state.config.gdpr.enabled:"&gdpre=1","string"==typeof state.config.gdpr.consent&&(c+="&gdprc="+encodeURIComponent(state.config.gdpr.consent)))),f=""+PROTOCOL+g+h+"/bid?"+c}function _QHandler(){state&&state.hasOwnProperty("Q")&&state.Q.forEach(function(a){"i"===a[0]?window.apstag.init.apply(null,a[1]):window.apstag.fetchBids.apply(null,a[1])})}function _validateConfig(a){return dispatch({type:"SET_CONFIG",config:a}),"success"}function _isDealsEnabled(){return state.hasOwnProperty("config")&&state.config.hasOwnProperty("deals")&&state.config.deals===!0}function _isOASDisplayAdServer(){return state.hasOwnProperty("config")&&state.config.hasOwnProperty("adServer")&&"oas"===state.config.adServer}function _isGoogletagDisplayAdServer(){return state.hasOwnProperty("config")&&state.config.hasOwnProperty("adServer")&&"googletag"===state.config.adServer}function _hasGoogletagLoaded(){return"undefined"!=typeof googletag&&googletag.hasOwnProperty("apiReady")&&googletag.apiReady===!0}function _hasGoogletagCmdBeenDefined(){return"undefined"!=typeof googletag?"undefined"!=typeof googletag.cmd:!1}function _safeGoogletagApplySlotTargeting(a){var b=a.slotID;a.hasOwnProperty("mediaType")&&"video"===a.mediaType||_safeWindowHasOwnProperty("googletag")&&_hasGoogletagCmdBeenDefined()&&(_hasGoogletagLoaded()?_getGoogletagSlot(b)&&_applyTargetingToGPTSlot(a):googletag.cmd.push(function(){_safeGoogletagApplySlotTargeting(a)}))}function _getGoogletagSlot(a){var b;try{b=_googletagSlots().filter(function(b){return b.getSlotElementId()===a})[0]}catch(c){_reportErrorSimple(c,"__error-getGoogletagSlot__")}return b}function _getCorrectBidCacheId(a){var b;return b=a.hasOwnProperty("amzniid")?a.amzniid:a.amzniid_sp}function _checkAllPossibleBidCacheIds(a,b,c){return a.amzniid===b||a[c+"amzniid"]===b||a.amzniid_sp===b}function _clearTargetingFromGPTSlot(a){var b,c;try{b=state.targetingKeys[a],_hasGoogletagLoaded()&&_isArray(b)&&(c=_getGoogletagSlot(a),b.forEach(function(a){return c.clearTargeting(a)}))}catch(d){_reportErrorSimple(d,"__error-clearTargetingFromGPTSlot__")}}function _findBidIDSetBySlotID(a){var b,c,d;try{c=state.slotBids,c.hasOwnProperty(a)&&(d=c[a],d.forEach(function(a){a.bidState===BID_STATES.set&&(b=_getCorrectBidCacheId(a))}))}catch(e){_reportErrorSimple(e,"__error-findBidIDSetBySlotID__")}return b}function _clearbidSetOnSlot(a){try{if(state.slotBids.hasOwnProperty(a)){var b=state.slotBids[a].filter(function(a){return a.bidState===BID_STATES.set})[0];b&&b.bidState===BID_STATES.set&&dispatch({type:"BID_STATE_CHANGE",slotID:a,bidID:_findBidIDSetBySlotID(a),bidState:BID_STATES.exposed})}}catch(c){_reportErrorSimple(c,"__error-clearbidSetOnSlot__")}}function _updateCurImpressionsTracked(a,b,c){dispatch({type:"SLOT_IMP_CHANGE",slotID:a,iid:b,ts:c})}function _areTwoURlsTheSame(a,b){var c=decodeURIComponent(a).split("?")[0].split("#")[0],d=decodeURIComponent(b).split("?")[0].split("#")[0];return c===d}function _inArray(a,b){return a.indexOf(b)>-1}function _isArray(a){return"[object Array]"===Object.prototype.toString.call(a)}function _hasAllItemsInArray(a,b){return a.map(function(a){return _inArray(b,a)}).filter(function(a){return a}).length===a.length}function _googletagSlots(){var a=[];try{_hasGoogletagLoaded()&&(a=googletag.pubads().getSlots())}catch(b){_reportErrorSimple(b,"__error-googletagSlots__")}return a}function _getCurrentSlotBids(){var a={};try{Object.keys(state.slotBids).forEach(function(b){var c,d=state.slotBids[b];d.filter(function(a){return a.bidState===BID_STATES.set}).length>0||(c=d.filter(function(a){return Date.now()-state.AAXReqs.filter(function(b){return b.bidReqID===a.bidReqID})[0].rqTs<24e4}).filter(function(a){return _areTwoURlsTheSame(_getReferrerURL(),state.AAXReqs.filter(function(b){return b.bidReqID===a.bidReqID})[0].url)}).filter(function(a){return a.bidState!==BID_STATES.rendered}),c.length>0&&(a[b]=c.map(function(a){var b=state.AAXReqs.filter(function(b){return b.bidReqID===a.bidReqID})[0].rqTs;return _extends({},a,{rqTs:b})}).reduce(function(a,b){return a.rqTs>b.rqTs?a:b})))})}catch(b){_reportErrorSimple(b,"__error-getCurrentSlotBids__")}return a}function _getAllBidIdKeys(a,b){var c;return c=_isArray(state.targetingKeys[a])?b?["amzniid_sp"]:state.targetingKeys[a].filter(function(a){return a.indexOf("amzniid")>-1&&a.indexOf("amzniid_sp")<0}):["amzniid"]}function _findSlotBidByBidID(a,b){var c,d,e;try{e=state.slotBids,Object.keys(e).forEach(function(f){e[f].forEach(function(e){var g=_getAllBidIdKeys(f,b);g.forEach(function(b){e[b]===a&&(c=e,"amzniid_sp"===b?d="sp":"amzniid"!==b&&(d=b.substr(0,b.indexOf("amzniid"))))})})})}catch(f){_reportErrorSimple(f,"__error-findSlotBidByBidID__")}return{slotBid:c,dealId:d}}function _getPMPBidSize(a,b,c){var d;return b[c+"amzniid"]===a&&(d=c.split("_").pop().trim()),d}function _mergeVideoBids(a){var b={};return a.slots.forEach(function(a){"video"!==a.mediaType?b[a.slotID]=a:(a.slotID.indexOf("rsv-")>=0&&(a={slotID:a.slotID.substring(4),r_amznbid:a.amznbid,r_amzniid:a.amzniid,r_amznp:a.amznp,mediaType:"video",targeting:["r_amznbid","r_amzniid","r_amznp"]}),b[a.slotID]?(a.targeting=a.targeting.concat(b[a.slotID].targeting),b[a.slotID]=_extends({},b[a.slotID],a)):b[a.slotID]=a)}),Object.keys(b).map(function(a){return b[a]})}function _convertAAXResponse(a){var b,c=_mergeVideoBids(a),d=["host","ev","cb","cmp"];try{b=c.map(function(b){var c={bidState:BID_STATES["new"]};return b.hasOwnProperty("amznsz")||(c.amznsz=b.size),d.forEach(function(b){var d,e;a.hasOwnProperty(b)&&(d=a[b],e=b,"cb"===b&&(e="bidReqID"),c[e]=d)}),_extends({},b,c)})}catch(e){_reportErrorSimple(e,"__error-convertAAXResponse__")}return b}function _applyTargetingToGPTSlot(a){try{var b,c=a.slotID,d=_getCorrectBidCacheId(a),e=a.targeting?a.targeting:_targetingKeys("display");b=_getGoogletagSlot(c),b&&(Object.keys(a).filter(function(a){return _inArray(e,a)}).forEach(function(c){return b.setTargeting(c,a[c])}),dispatch({type:"BID_STATE_CHANGE",slotID:c,bidID:d,bidState:BID_STATES.set}))}catch(f){_reportErrorSimple(f,"__error-applyTargetingToGPTSlot__")}}function _applySuppliedSlotBidsToGoogletag(a){var b=_getCurrentSlotBids();a.forEach(function(a){b[a]&&_safeGoogletagApplySlotTargeting(b[a])})}function _applyAllCurrentSlotBidsTargetingToGoogletag(){var a=_getCurrentSlotBids();Object.keys(a).forEach(function(b){_safeGoogletagApplySlotTargeting(a[b])})}function _applyGPTSlotTargeting(a){try{a?_applySuppliedSlotBidsToGoogletag(a):_applyAllCurrentSlotBidsTargetingToGoogletag(),state.DFP.slotRenderEndedSet||(googletag.cmd.push(function(){googletag.pubads().addEventListener("slotRenderEnded",function(a){_clearTargetingFromGPTSlot(a.slot.getSlotElementId()),_clearbidSetOnSlot(a.slot.getSlotElementId())})}),dispatch({type:"DFP_SLOT_RENDER_ENDED_SET"}))}catch(b){_reportErrorSimple(b,"__error-applyGPTSlotTargeting__")}}function _creativeURL(a){var b,c="?b="+a.bidID+"&rnd="+_getRnd(),d=""+a.host+DTB_PATH+"/imp";return _safeObjectHasProperty(a,"pp")&&(c+="&pp="+a.pp),_safeObjectHasProperty(a,"amznp")&&(c+="&p="+a.amznp),_safeObjectHasProperty(a,"crID")&&(c+="&crid="+a.crID),b="1"===a.fif?d+"j"+c:d+"i"+c}function _baseIframe(a){var b=a.doc.createElement("iframe");return b.frameBorder=0,b.marginHeight=0,b.marginWidth=0,b.topMargin=0,b.leftMargin=0,b.scrolling="no",b.allowTransparency=!0,b.width=a.sizes[0]+"px",b.height=a.sizes[1]+"px",b}function _renderAmpImpression(a){var b={bidID:a.amzniid,doc:a.document,pp:a.amznbid.split("_").pop(),host:a.amznhost,adID:"amznad"+Math.round(1e6*Math.random()),sizes:a.amznsz.split("x"),fif:!1,isAmp:!0,amznp:a.amznp};_loadAdIntoUnfriendlyIframe(b)}function _loadAdIntoFriendlyIframe(a){var b=_baseIframe(a);b.id="apstag-f-iframe-"+_getRnd(),b.srcdoc=a.html,a.doc.body.appendChild(b)}function _loadAdIntoUnfriendlyIframe(a,b){var c,d=_baseIframe(a);d.id=a.adID,d.sandbox="allow-forms allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation",debugCheck?(c='<body style="background-color: #FF9900;">'+(a.sizes[1]>50?"<h3>apstag Test Creative</h3>":"")+"<h4>amzniid - "+a.bidID+" | amznbid: "+a.pp+" | size: "+a.sizes.join("x")+"</h4></body>",d.src="javascript:'"+c+"'"):d.src=_creativeURL(a),a.doc.body.appendChild(d),b&&_safeOnload(a.doc.getElementById(a.adID),function(){return b(a.doc,a.bidID,d)})}function _triggerViewability(a,b,c){var d;_safeWindowHasOwnProperty("amzncsm")?d=window.amzncsm:a.defaultView.hasOwnProperty("amzncsm")&&(d=a.defaultView.amzncsm),d&&(d.host=_aaxHost(),d.rmD(c,b,a.defaultView,a,state.config.pubID))}function _getNewSlotBidsAndExposeForRequestedSlots(a){var b=a.map(_getSlotID),c={};return Object.keys(state.slotBids).forEach(function(a){var d=state.slotBids[a].filter(function(a){return a.bidState===BID_STATES["new"]})[0];d&&_inArray(b,a)&&(c[a]=d,dispatch({type:"BID_STATE_CHANGE",slotID:a,bidID:_getCorrectBidCacheId(d),bidState:BID_STATES.exposed}))}),c}function _createPublicStateTrackingBigObject(a,b){var c,d,e="0x0";return _isDealsEnabled()?(d=["amznbid","amzniid","amznp","amznsz"],c={slotID:a,size:e,mediaType:"banner",targeting:{amznbid:b,amzniid:"",amznp:b,amznsz:e},helpers:{targetingKeys:d}}):c={slotID:a,amzniid:"",amznbid:b,amznp:b,amznsz:e,size:e},c}function _createQsParams(a,b){var c="";return a.targeting.forEach(function(b){c+="&"+b+"="+a[b]}),b===!0&&(c=encodeURIComponent(c)),c}function _constructStateTrackingBids(a,b,c){var d=b.slots.filter(_isDisplaySlot).map(_getSlotID),e=a.map(_getSlotID),f=[];return f=c?d.map(function(a){return _createPublicStateTrackingBigObject(a,slotStates.bidInFlight)}):d.reduce(function(a,b){return _inArray(e,b)||a.push(_createPublicStateTrackingBigObject(b,slotStates.noBid)),a},[]),a.concat(f)}function _bidCallbackHandler(a,b){return function(c){var d,e=_getNewSlotBidsAndExposeForRequestedSlots(b.slots),f=Object.keys(e),g=[];c&&(dispatch({type:"RECORD_AAX_RESPONSE_PROP",bidReqID:b.bidReqID,key:"timedOutAt",value:Date.now()}),state.experiments.chunkRequests&&dispatch({type:"RECORD_TIMEOUT",fid:b.bidReqID,timeOut:Date.now()})),f.forEach(function(a){var b,c,d;e.hasOwnProperty(a)&&(b=e[a],c={},_isDealsEnabled()?(b.meta.forEach(function(a){c[a]=b[a]}),c.targeting={},b.targeting.forEach(function(a){c.targeting[a]=b[a]}),c.helpers={targetingKeys:b.targeting,qsParams:_createQsParams.bind(null,b,!1),encodedQsParams:_createQsParams.bind(null,b,!0)}):b.hasOwnProperty("amznbid")?(b.hasOwnProperty("amznp")||(b.amznp=""),c={amzniid:b.amzniid,amznbid:b.amznbid,amznp:b.amznp,slotID:a},b.hasOwnProperty("size")&&(c.size=b.size,c.amznsz=b.amznsz),"video"===b.mediaType&&(c.mediaType="video",d="",b.amznbid?d+="&amzniid="+b.amzniid+"&amznbid="+b.amznbid+"&amznp="+b.amznp:(c.amznbid="",c.amzniid=""),b.r_amznbid?(c.r_amznbid=b.r_amznbid,c.r_amzniid=b.r_amzniid,c.r_amznp=b.r_amznp,d+="&r_amzniid="+b.r_amzniid+"&r_amznbid="+b.r_amznbid+"&r_amznp="+b.r_amznp):(c.r_amznbid="",c.r_amzniid="",c.r_amznp=""),c.qsParams=d,c.encodedQsParams=encodeURIComponent(d))):c=_createPublicStateTrackingBigObject(b.slotID,slotStates.noBid),g.push(c))}),_isGoogletagDisplayAdServer()&&(g=_constructStateTrackingBids(g,b,c)),d={fromTimeout:c},a(g,d)}}function _resizeIframe(a,b){try{var c;c=a.defaultView&&a.defaultView.frameElement?a.defaultView.frameElement:window.frameElement,c.width=b[0],c.height=b[1]}catch(d){_reportErrorSimple(d,"__error-resizeIframe__")}}function _sizeArrayToSring(a){return a[0]+"x"+a[1]}function _pickRandomSizeForMockBid(a){var b,c;return 1===a.length?b=_sizeArrayToSring(a[0]):(c=Math.floor(a.length*Math.random()),b=_sizeArrayToSring(a[c])),b}function _doMockBid(a,b){var c,d=_aaxHost(),e=_getReferrerURL(),f=a.bidReqID,g=_getWindowDimensions(),h=_debugProp("testBidTimeout")||200;dispatch({type:"RECORD_AAX_REQUEST",data:{bidConfig:a,timeout:h,bidReqID:f,ws:g,url:e,rqTs:Date.now()}}),c=a.slots.map(function(a){var b,c,d,e={slotID:a.slotID,amzniid:MOCKBID.amzniid+"-"+_getRnd(),amznbid:MOCKBID.amznbid,amznp:MOCKBID.amznp,crid:MOCKBID.crid+"-"+_getRnd()};return a.hasOwnProperty("sizes")?(b=_pickRandomSizeForMockBid(a.sizes),e.size=b,e.amznsz=b):"video"===a.mediaType&&(e.mediaType="video",e.amznbid="v_"+e.amznbid),_isDealsEnabled()&&(e.mediaType="banner",e.meta=["slotID","mediaType","size"],e.amznbid_sp=MOCKBID.amznbid+"SP",e.amznp_sp=MOCKBID.amznp+"SP",e.amznsz_sp=e.size,c="testDeal"+_getRnd()+"_"+e.size,d="testDealImpression-"+_getRnd(),e.amzndeal_sp=c,e.amzndeals=[c],e[c+"amzniid"]=d,e.amzniid_sp=d,e.targeting=["amzniid","amznbid","amznp","amznsz","amzniid_sp","amznbid_sp","amznp_sp","amznsz_sp","amzndeal_sp","amzndeals",c+"amzniid"]),e}),window.setTimeout(function(){window.apstag.bids({slots:c,host:d,status:"ok",cb:f}),b(!0)},h)}function _getSlotID(a){return a.slotID}function _determineNoBidStateForDFP(a){var b,c,d,e=state.AAXReqs.filter(function(b){return b.bidReqID===a.cb})[0];e&&e.bidConfig&&e.bidConfig.slots&&(b=e.bidConfig.slots.filter(_isDisplaySlot).map(function(a){return a.slotID}),c=a.hasOwnProperty("slots")?a.slots.map(function(a){return a.slotID}):[],d=b.filter(function(a){return!_inArray(c,a)}),dispatch({type:"NO_BID_ON_DFP_SLOTS",slotIDs:d}),_hasGoogletagLoaded()?_applyNoBidFromAAXState():_hasGoogletagCmdBeenDefined()&&googletag.cmd.push(function(){_applyNoBidFromAAXState()}))}function _isRequestInFlightForThisSlot(a){return _inArray(state.AAXReqs.filter(function(a){return!a.resTs}).map(function(a){return a.bidConfig.slots}).reduce(function(a,b){return a.concat(b)},[]).map(_getSlotID),a)}function _isRealAmznbidTargetingSetOnSlot(a){var b=a.getTargeting("amznbid");return b.length>0&&b[0].length>2}function _applyNoBidFromAAXState(){_isGoogletagDisplayAdServer()&&(_hasGoogletagLoaded()&&"1"===googletag.pubads().getTargeting("amznbid")[0]&&_clearBidStateTargeting(),_googletagSlots().forEach(function(a){!_inArray(state.DFP.noBidSlotIDs,a.getSlotElementId())||_isRequestInFlightForThisSlot(a.getSlotElementId())||_isRealAmznbidTargetingSetOnSlot(a)||"2"===a.getTargeting("amznbid")[0]||_setBidState(a,"noBid")}))}function _setBidState(a,b){SLOT_STATE_KEYS.forEach(function(c){return a.setTargeting(c,slotStates[b])})}function _clearBidStateTargeting(){SLOT_STATE_KEYS.forEach(function(a){return googletag.pubads().clearTargeting(a)})}function _sendDupeBidPixel(a){var b={_type:"dupePixel",dd:Date.now()-a.renderTime},c=_bidCacheIDPixelSrc(a.amzniid,b);_pixel(c)}function _reportErrorSimple(a,b){if("undefined"==typeof state||"undefined"==typeof state.config)_reportError(a,b);else{var c=state.config.isSelfServPub,d=SELF_SERVE_PUB_SRC,e=state.config.pubID,f=_pixelBaseURL();_reportError(a,b,c,d,e,f)}}function _sendInitLatencyPixel(){var a=_getPerformanceObject("apstag"),b={pid:PAGELOAD_ID,ns:NAV_START,fs:_getFetchStart(a),re:_getResponseEnd(a)},c=_nonBidCacheIDPixelSrc(b);window.setTimeout(function(){_pixel(c)},1e3)}function _sendBidsSetOnDFPPixel(){try{window.setTimeout(function(){var a,b=_getBidSetInfo().filter(function(a){return!state.bsPixels.hasOwnProperty(a.iid)||a.state!==state.bsPixels[a.iid]});b&&b.length&&b.length>0&&(b.forEach(function(b){a=_bidCacheIDPixelSrc(b.iid,_mapBidInfoToPixel(b)),_pixel(a)}),_recordBidsSetPixelsSent(b)),_sendBidsSetOnDFPPixel()},5e3)}catch(a){_reportErrorSimple(a,"__error-bidSetPixel__")}}function constructViewabilityPixel(){Object.keys(state.curDFPViewability).forEach(function(a){dispatch({type:"SAVE_DFP_VIEWABILITY",slotID:a})});var a={pid:PAGELOAD_ID,ns:NAV_START,pl:_getWindowsPerformanceTiming("loadEventStart"),pe:Date.now(),n:state.allDFPViewability.length,_type:"DFPViewability",slots:state.allDFPViewability};return _nonBidCacheIDPixelSrc(a)}function _sendDFPViewabilityPixel(){var a=constructViewabilityPixel();_pixel(a)}function _trackDFPViewabilityPixel(){googletag.cmd.push(function(){googletag.pubads().addEventListener("slotOnload",function(a){try{dispatch({type:"SET_DFP_VIEWABILITY_PROPERTY",slotID:a.slot.getSlotElementId(),prop:"loadTs",val:Date.now()})}catch(b){}}),googletag.pubads().addEventListener("impressionViewable",function(a){try{dispatch({type:"SET_DFP_VIEWABILITY_PROPERTY",slotID:a.slot.getSlotElementId(),prop:"viewTs",val:Date.now()})}catch(b){}}),googletag.pubads().addEventListener("slotRenderEnded",function(a){var b,c,d;try{b=a.slot.getSlotElementId(),(!state.curSlotImps.hasOwnProperty(b)||state.curSlotImps[b].slotRendered)&&_updateCurImpressionsTracked(b,null,null),dispatch({type:"SLOT_RENDERED",slotID:b}),c=state.curSlotImps[b].iid,d=state.curSlotImps[b].ts,state.curDFPViewability.hasOwnProperty(b)&&dispatch({type:"SAVE_DFP_VIEWABILITY",slotID:b}),dispatch({type:"SET_DFP_VIEWABILITY_PROPERTY",slotID:b,prop:"iid",val:c}),dispatch({type:"SET_DFP_VIEWABILITY_PROPERTY",slotID:b,prop:"renderStartTs",val:d})}catch(e){}})}),window.addEventListener("beforeunload",_sendDFPViewabilityPixel)}function _bidCacheIDPixelSrc(a,b){return b._tl="aps-tag",""+_pixelBaseURL()+a+"/"+_objToURLParam(b)}function _nonBidCacheIDPixelSrc(a){return a._tl="aps-tag",_pixelBaseURL()+"p/PH/"+_objToURLParam(a)}function _recordBidsSetPixelsSent(a){a.forEach(function(a){return dispatch({type:"RECORD_BID_INFO_SENT",bidInfo:a})})}function _mapBidInfoToPixel(a){var b,c={};try{b=_findAAXReqMatch(a.fid),c={status:a.state,pubid:state.config.pubID,_type:"bidSetPixel"},c.toa=b.req.hasOwnProperty("timedOutAt")?b.req.timedOutAt:"0",c.fbrq=b.req.rqTs,c.pto=b.req.timeout,c.ns=b.req.bidConfig.slots.length,c.bla=b.req.resTs-b.req.rqTs,c.reqindex=b.index,c.fid=a.fid,CHUNK_BID_REQUESTS_PROPORTION&&(c.eid=state.experiments.chunkRequests?2:1,c.fbindex=b.fbIndex,c.fbns=state.bidConfigs[a.fid.split("-")[0]].slots.length),a.delta&&(c.delay=a.delta)}catch(d){_reportErrorSimple(d,"__error-mapBidInfoToPixel__")}return c}function _findAAXReqMatch(a){var b={req:state.AAXReqs.filter(function(b){return b.bidReqID===a})[0]};return b.index=state.AAXReqs.indexOf(b.req)+1,state.experiments.chunkRequests?b.fbIndex=state.AAXReqs.filter(function(a){return-1===a.bidReqID.indexOf("-")||"0"===a.bidReqID.split("-")[1]}).map(function(a){return a.bidReqID.split("-")[0]}).indexOf(a.split("-")[0])+1:b.fbIndex=b.index,b}function _getBidSetInfo(){var a=_getDFPSlotFetches(),b=[];return a?(Object.keys(state.slotBids).forEach(function(c){"video"!==state.slotBids[c][0].mediaType&&state.slotBids[c].filter(function(a){return"undefined"!=typeof a.amzniid}).forEach(function(d){var e,f,g={slotID:c,iid:d.amzniid,fid:d.bidReqID},h=[],i=[];c in a&&(h=a[c].fetchedAt.filter(function(a){return a.AAXReqInfo&&a.AAXReqInfo.bidReqID===d.bidReqID}),i=a[c].targetedAt.filter(function(a){return a.targeting===d.amzniid})),h.length>0?h.length>0&&i.length>=h.length&&h.slice(h.length-1)[0].ts>i.slice(h.length-1)[0].ts?1===a[c].fetchWithIID.filter(function(a){return a===d.amzniid}).length?g.state=1:g.state=4:-1!==a[c].fetchWithIID.indexOf(d.amzniid)?g.state=3:g.state=2:g.state=0,(1===g.state||2===g.state)&&(e=state.AAXReqs.filter(function(a){return a.bidReqID===d.bidReqID})[0].resTs,f=_findClosestTsInList(e,a[c].fetchedAt,2===g.state),f&&f.hasOwnProperty("ts")&&(g.delta=e-f.ts)),b.push(g)})}),b):b}function _findClosestTsInList(a,b,c){var d=b.map(function(b){var d=a-b.ts;return c?d>=0?d:null:0>=d?-d:null}),e=_indexOfMin(d);return b[e]}function _indexOfMin(a){var b,c,d,e;for(e=0;e<a.length;e++)b=a[e],"number"==typeof b&&("number"!=typeof d||c>b)&&(d=e,c=b);return d}function _findCorrspondingAAXFetch(a,b){return state.AAXReqs.filter(function(a){var c=a.bidConfig.slots.map(function(a){return a.slotID});return c.indexOf(b)>-1})[a]}function _getDFPSlotFetches(){if(!_hasGoogletagLoaded())return null;var a=googletag.debug_log.getAllEvents().map(function(a){var b=a.getMessage(),c=a.getSlot();return{id:b.getMessageId(),args:b.getMessageArgs(),slotID:c?c.getSlotElementId():null,ts:a.getTimestamp().getTime()}}).filter(function(a){return 17===a.id&&"amzniid"===a.args[0]||103===a.id&&"amzniid"===a.args[0]||3===a.id}).reduce(function(a,b){a.hasOwnProperty(b.slotID)||(a[b.slotID]={fetchedAt:[],targetedAt:[]});var c=a[b.slotID];return 3===b.id?c.fetchedAt.push({ts:b.ts,AAXReqInfo:_findCorrspondingAAXFetch(a[b.slotID].fetchedAt.length,b.slotID)}):17===b.id?c.targetedAt.push({ts:b.ts,targeting:b.args[1]}):103===b.id&&c.targetedAt.push({ts:b.ts,targeting:""}),a},{});return Object.keys(a).forEach(function(b){
var c=a[b];c.fetchWithIID=c.fetchedAt.map(function(a){var b=_findClosestTsInList(a.ts,c.targetedAt,!0);return b?b.targeting:0}),a[b]=c}),a}function _startTests(){_startHttpsTest(),_startEdgeTest()}function _startHttpsTest(){"http://"===_getProtocol()&&new TestSuite(utils,pixeling,redux,{run:_run2UrlTest.bind(null,["http","https"]),cases:{aax:["http://d29a6k4186aqcx.cloudfront.net/2k.txt","https://d29a6k4186aqcx.cloudfront.net/2k.txt"],cf:["http://d29a6k4186aqcx.cloudfront.net/2k.txt","https://d29a6k4186aqcx.cloudfront.net/2k.txt"]},name:"https"})}function _startEdgeTest(){new TestSuite(utils,pixeling,redux,{run:_run2UrlTest.bind(null,["aax","cf"]),cases:{tst:["https://d29a6k4186aqcx.cloudfront.net/2k.txt","https://d29a6k4186aqcx.cloudfront.net/2k.txt"]},name:"edge-server"})}function _run2UrlTest(a,b,c){c=_addCbToUrls(c),_xhrRequestManager(_shuffleArray(c),function(){var d;return b((d={pubID:state.config?state.config.pubID:null},_defineProperty(d,a[0],_getRoundTripTime(c[0])),_defineProperty(d,a[1],_getRoundTripTime(c[1])),d))})}function _addCbToUrls(a){return a.map(function(a){return""+a+(-1===a.indexOf("?")?"?":"&")+"cb="+_getRnd()})}function _shuffleArray(a){var b,c,d=a.length;for(a=[].concat(_toConsumableArray(a));0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}function _getRoundTripTime(a){try{var b=_getPerformanceObject(a);return _getResponseEnd(b)-_getFetchStart(b)}catch(c){return _reportErrorSimple(c,"__getRoundTripTime-error__"),0}}function _xhrRequestManager(a,b){var c,d={requests:{},callback:!1};a.map(function(a){d.requests[a]=!1}),c=function(a){d.requests[a]=!0,!d.callback&&_areAllKeysTruthy(d.requests)&&b()},a.map(function(a){_xhrGetRequest({url:a,onload:c.bind(null,a),onerror:c.bind(null,a,!0)})})}function _areAllKeysTruthy(a){var b=Object.keys(a);return b.map(function(b){return a[b]}).filter(function(a){return a}).length===b.length}function _applyNoRequestToAAXState(){_isGoogletagDisplayAdServer()&&(_hasGoogletagLoaded()?_setBidState(googletag.pubads(),"noRequest"):_hasGoogletagCmdBeenDefined()&&(googletag.cmd=[function(){_setBidState(googletag.pubads(),"noRequest")}].concat(_toConsumableArray(googletag.cmd))))}function _isDisplaySlot(a){return"video"!==a.mediaType}function _setRequestToAAXInFlightState(a){_isGoogletagDisplayAdServer()&&_hasGoogletagCmdBeenDefined()&&(dispatch({type:"REQUESTED_BID_FOR_DFP_SLOTS",slotIDs:a}),dispatch({type:"REQUESTED_BID_FOR_PMP_ONLY_DFP_SLOTS",slotIDs:a}),googletag.cmd.push(function(){var b=_googletagSlots();"0"===googletag.pubads().getTargeting("amznbid")[0]&&_clearBidStateTargeting(),_hasAllItemsInArray(a,b.map(function(a){return a.getSlotElementId()}))?b.forEach(function(b){_inArray(a,b.getSlotElementId())&&!_isRealAmznbidTargetingSetOnSlot(b)&&_setBidState(b,"bidInFlight")}):googletag.cmd.push(function(){_setBidState(googletag.pubads(),"bidInFlight")})}))}function _debug(a){switch(a){case"getLog":return state.eventLog;case"getState":return state;case"enable":return _safeDebugSet(!0),"DEBUG MODE ENABLED";case"disable":return _safeDebugSet(!1),"DEBUG MODE DISABLED";case"enableConsole":return _debugConsole(apstagConsoleEnabled),"Debug console enabled";case"disableConsole":return _debugConsole(apstagConsoleDisabled),"Debug console disabled";default:return"unknown debug argument"}}function parseSize(a){return a.split("x").map(function(a){return parseInt(a,10)})}function _renderImp(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=Date.now();return a.type&&"amp"===a.type?void _renderAmpImpression(a):(c=!1,0===b.indexOf("sp|")&&(b=b.substring(3),c=!0),d=b||a.amzniid,e=_findSlotBidByBidID(d,c),f=e.slotBid,g=e.dealId,h=parseSize(g&&g.length>=1?"sp"===g?f.amznsz_sp:_getPMPBidSize(d,f,g):f.size),1===arguments.length?void _loadAdIntoFriendlyIframe({doc:f.doc,sizes:h,html:a.html}):void(f&&(f.bidState===BID_STATES.rendered&&_sendDupeBidPixel(f),dispatch({type:"BID_STATE_CHANGE",slotID:f.slotID,bidID:b,bidState:BID_STATES.rendered,dealId:g}),state.shouldSampleLatency&&_updateCurImpressionsTracked(f.slotID,d,o),metrics.addTimer("imp"),i=f.host,j="amznad"+Math.round(1e6*Math.random()),k=_getProperBidInfoValue("amznbid",f,g),l=_getProperBidInfoValue("amznp",f,g),m=_getProperBidInfoValue("crid",f,g),n={bidID:b,doc:a,pp:k,host:i,adID:j,sizes:h,amznp:l,crID:m,fif:!1},"1"===f.fif?(n.fif="1",dispatch({type:"STORE_IMPRESSION_DOC_REF",slotID:f.slotID,bidID:b,doc:a,dealId:g}),_loadScriptTag(_creativeURL(n),null,document)):state.aaxViewabilityEnabled?_isOASDisplayAdServer()&&"loading"===a.readyState?a.addEventListener("DOMContentLoaded",function(){_loadViewabilityAd(n,a)}):_loadViewabilityAd(n,a):_loadAdIntoUnfriendlyIframe(n),_resizeIframe(a,h))))}function _getProperBidInfoValue(a,b,c){var d;return d=c&&c.length>=1?"sp"===c?b[a+"_sp"]:"":b[a]?b[a]:""}function _loadViewabilityAd(a,b){var c=b.createElement("script");c.type="text/javascript",c.async=!0,b.body.appendChild(c),_safeOnload(c,function(){_loadAdIntoUnfriendlyIframe(a,_triggerViewability)}),c.src=CSM_JS}function _bids(a){_doOnAAXResponse(a),dispatch({type:"UPDATE_SLOT_BIDS",bids:_convertAAXResponse(a)}),a.hasOwnProperty("ev")&&dispatch({type:"SET_VIEWABILITY",viewability:a.ev}),_doAfterAAXResponse(a)}function _isChunkConfigValid(){return"number"==typeof MAX_SLOTS_PER_REQUEST&&MAX_SLOTS_PER_REQUEST>0}function _fetchBids(a,b){var c,d,e,f,g=adjustSlotArraySizes(a.slots);g&&(a.slots=g);try{d=a.timeout||state.config.bidTimeout||DEFAULT_TIMEOUT,"function"!=typeof b&&(b=function(){}),a.bidReqID=_getRnd(),c=_wrapCallback(_bidCallbackHandler(b,a),d)}catch(h){_reportErrorSimple(h,"__error-fetchBids__")}if(0===a.slots.length)return _reportErrorSimple(new Error("No slots provided for bid request"),"__error-no_slots_provided_bid_request__"),void setTimeout(b.bind(null,[]),10);if(_setRequestToAAXInFlightState(a.slots.filter(_isDisplaySlot).map(_getSlotID)),dispatch({type:"NEW_FETCH_BID_REQUEST",fid:a.bidReqID,pto:d}),dispatch({type:"RECORD_ORIGINAL_BID_CONFIG",bidConfig:a}),debugCheck)_doMockBid(a,c);else if(HAS_XHR_SUPPORT)if(dispatch({type:"SHOULD_CHUNK_REQUESTS"}),state.experiments.chunkRequests&&_isChunkConfigValid()){for(e=chunkConfig(a),f=0;f<e.length;f++)e[f].bidReqID=a.bidReqID+"-"+f;dispatch({type:"ADD_CHUNKED_REQUESTS",fid:a.bidReqID,numChunks:e.length}),e.forEach(function(a){_xhrBid(_bidURL(a,d),c,a.bidReqID)})}else _xhrBid(_bidURL(a,d),c,a.bidReqID);else _loadScriptTag(_bidURL(a,d),c)}function chunkConfig(a){var b,c,d=Math.ceil(a.slots.length/MAX_SLOTS_PER_REQUEST),e=new Array(d);for(b=0;d>b;b++)c=b*MAX_SLOTS_PER_REQUEST,e[b]={slots:a.slots.slice(c,c+MAX_SLOTS_PER_REQUEST)};return e=e.map(function(b){return _extends({},a,b)})}function adjustSlotArraySizes(a){try{return a.map(function(a){return a.sizes&&_isArray(a.sizes)&&!_isArray(a.sizes[0])?_extends({},a,{sizes:[a.sizes]}):a})}catch(b){_reportErrorSimple(b,"__error-adjustSlotArraySizes__")}return!1}function _punt(a){a.punt=!0,_doOnAAXResponse(a),_doAfterAAXResponse(a)}function _setDisplayBids(a){state.config.hasOwnProperty("adServer")&&_isGoogletagDisplayAdServer()&&(_applyGPTSlotTargeting(a),_applyNoBidFromAAXState())}function _init(a,b){var c=_validateConfig(a);_applyNoRequestToAAXState(),"success"===c&&"function"==typeof b&&b()}function _targetingKeys(){var a=arguments.length<=0||void 0===arguments[0]?"display":arguments[0];switch(a){case"display":return DISPLAY_TARGETING_KEYS;case"video":return VIDEO_TARGETING_KEYS;default:return _isDealsEnabled()&&_isArray(state.targetingKeys[a])?state.targetingKeys[a]:"unknown targeting type "+a}}function _fetchDebugHTML(){var a=new XMLHttpRequest,b="GET",c=DEBUG_APP_HTML;a.open(b,c,!0),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&200===a.status&&_appendDebugIframe(a.responseText)},a.send()}function _appendDebugIframe(a){var b=document.createElement("iframe");b.frameBorder=0,b.marginHeight=0,b.marginWidth=0,b.topMargin=0,b.leftMargin=0,b.scrolling="no",b.allowTransparency=!0,b.width="100%;",b.height="200px",b.id="apstag-debug-iframe",b.srcdoc=a,b.style="background: #eaeded; z-index: 2147483647; line-height: 1; text-align: center; font-size: 12px; font-family: sans-serif; font-weight: bold; bottom: 0; position: fixed !important;",document.body.appendChild(b)}function _proxyMethod(a,b){var c=b;return b=function(){return _logEvent({method:a,args:arguments}),c.apply(void 0,arguments)}}function _addErrorHandlingToMethod(a){return function(){try{return a.apply(void 0,arguments)}catch(b){return _reportErrorSimple(b,a.name),null}}}var state,store,dispatch,DEFAULT_AAX_HOST,CSM_JS,CHUNK_BID_REQUESTS_PROPORTION,DEBUG_APP_HTML,DEFAULT_TIMEOUT,DTB_PATH,PIXEL_PATH,LATENCY_SAMPLING_RATE,COOKIE_MATCH_DELAY,MAX_SLOTS_PER_REQUEST,metrics,pixeling,utils,redux,HAS_PERFORMANCE_SUPPORT=_safeWindowHasOwnProperty("performance"),PROTOCOL=_getProtocol(),NAV_START=_getWindowsPerformanceTiming("navigationStart"),DEBUG_GLOBAL="apstagDEBUG",DEBUG_LOCAL_STORAGE_KEY="apstagDebug",DEBUG_CONSOLE_LOCAL_STORAGE_KEY="apstagDebugConsole",CFG_LOCAL_STORAGE_KEY="apstagCfg",NO_LOCAL_STORAGE_SUPPORT_MAGIC_NUNMBER_FOR_AAX=0,MINIMUM_BID_TIMEOUT=0,PAGELOAD_ID=_getRnd(),MOCKBID={amznbid:"testBid",amzniid:"testImpression",amznp:"testP",crid:"testCrid"},MEDIA_TYPES_MAGIC_STRING_FOR_AAX={video:"v"},DISPLAY_TARGETING_KEYS=["amznbid","amzniid","amznsz","amznp"],VIDEO_TARGETING_KEYS=["amznbid","amzniid","amznp","r_amznbid","r_amzniid","r_amznp"],SLOT_STATE_KEYS=["amznbid","amznp"],BID_STATES={"new":"NEW",exposed:"EXPOSED",set:"SET",rendered:"RENDERED"},FIRST_PARTY_COOKIE_KEYS={__apsid:{urlParam:"ck"},__aps_id_p:{urlParam:"ckp"}},slotStates={noRequest:"0",bidInFlight:"1",noBid:"2"},apstagConsoleEnabled="apstagConsoleEnabled",apstagConsoleDisabled="apstagConsoleDisabled",AAX_RESP_REMAP_COOKIE_KEY="cr",SELF_SERVE_PUB_SRC="600",HAS_XHR_SUPPORT=function(){var a,b=!1;return"function"==typeof XMLHttpRequest&&(a=new XMLHttpRequest,"undefined"!=typeof a.withCredentials&&(b=!0)),b}(),lsPresent=function(){var a="amzn_lsTest";try{return window.localStorage.setItem(a,a),window.localStorage.removeItem(a),!0}catch(b){return!1}}(),debugCheck=function(){if(lsPresent){var a=window.localStorage.getItem(DEBUG_LOCAL_STORAGE_KEY);if("true"===a)return!0}return!1}(),debugConsole=function(){if(lsPresent){var a=window.localStorage.getItem(DEBUG_CONSOLE_LOCAL_STORAGE_KEY);if(a===apstagConsoleEnabled)return!0}return!1}(),reducer=function(){var a,b,c=arguments.length<=0||void 0===arguments[0]?{AAXReqs:[],bidReqs:{},bidConfigs:{},bsPixels:{},cfg:{},cmpFired:!1,config:{},DFP:{slots:[],noBidSlotIDs:[]},eventLog:[],experiments:{},slotBids:{},targetingKeys:{},aaxViewabilityEnabled:!1,curSlotImps:{},curDFPViewability:{},allDFPViewability:[],tests:{}}:arguments[0],d=arguments[1];switch(d.type){case"ADD_CHUNKED_REQUESTS":return _extends({},c,{bidReqs:_extends({},c.bidReqs,_defineProperty({},d.fid,_extends({},c.bidReqs[d.fid],{networkReqs:new Array(d.numChunks)})))});case"LOG_EVENT":return _extends({},c,{eventLog:[].concat(_toConsumableArray(c.eventLog),[d.event])});case"NEW_FETCH_BID_REQUEST":return _extends({},c,{bidReqs:_extends({},c.bidReqs,_defineProperty({},d.fid,{pto:d.pto,hasCallbackExecuted:!1}))});case"RECORD_NETWORK_EXCHANGE":return _extends({},c,{bidReqs:_extends({},c.bidReqs,_defineProperty({},d.fid,_extends({},c.bidReqs[d.fid],{networkReqs:_extends([].concat(_toConsumableArray(c.bidReqs[d.fid].networkReqs)),_defineProperty({},d.networkID,_extends({},c.bidReqs[d.fid].networkReqs[d.networkID],(a={},_defineProperty(a,d.exchangeType+"Time",d.timestamp),_defineProperty(a,"inFlight","request"===d.exchangeType),a))))})))});case"RECORD_CALLBACK":return _extends({},c,{bidReqs:_extends({},c.bidReqs,_defineProperty({},d.fid,_extends({},c.bidReqs[d.fid],{hasCallbackExecuted:!0})))});case"RECORD_TIMEOUT":return _extends({},c,{bidReqs:_extends({},c.bidReqs,_defineProperty({},d.fid,_extends({},c.bidReqs[d.fid],{networkReqs:c.bidReqs[d.fid].networkReqs.map(function(a){return a.inFlight?_extends({},a,{timeOut:d.timeOut}):a})})))});case"SET_CONFIG":return b=_extends({},d.config),b.isSelfServPub=!1,b.pubID&&b.pubID.length>=5&&(b.isSelfServPub=!0),_extends({},c,{config:b});case"SET_Q":return _extends({},c,{Q:d.Q});case"SET_VIEWABILITY":return _extends({},c,{aaxViewabilityEnabled:d.viewability});case"CMP_FIRED":return _extends({},c,{cmpFired:!0});case"ENABLE_DEBUG":return _extends({},c,{debugEnabled:!0});case"DISABLE_DEBUG":return _extends({},c,{debugEnabled:!1});case"RECORD_AAX_REQUEST":return _extends({},c,{AAXReqs:[].concat(_toConsumableArray(c.AAXReqs),[d.data])});case"RECORD_AAX_RESPONSE_PROP":return _extends({},c,{AAXReqs:c.AAXReqs.map(function(a){return a.bidReqID===d.bidReqID&&(a[d.key]=d.value),a})});case"UPDATE_SLOT_BIDS":return _extends({},c,{slotBids:_extends({},c.slotBids,d.bids.reduce(function(a,b){return c.slotBids.hasOwnProperty(b.slotID)?a[b.slotID]=[].concat(_toConsumableArray(c.slotBids[b.slotID]),[b]):a[b.slotID]=[b],a},{})),targetingKeys:_extends({},c.targetingKeys,d.bids.reduce(function(a,b){return c.targetingKeys.hasOwnProperty(b.slotID)?a[b.slotID]=c.targetingKeys[b.slotID].concat(b.targeting?b.targeting.filter(function(a){return-1===c.targetingKeys[b.slotID].indexOf(a)}):[]):a[b.slotID]=b.targeting?b.targeting:_targetingKeys("display"),a},{}))});case"RECORD_BID_INFO_SENT":return _extends({},c,{bsPixels:_extends({},c.bsPixels,_defineProperty({},d.bidInfo.iid,d.bidInfo.state))});case"DFP_SLOT_RENDER_ENDED_SET":return _extends({},c,{DFP:_extends({},c.DFP,{slotRenderEndedSet:!0})});case"BID_STATE_CHANGE":return _extends({},c,{slotBids:_extends({},c.slotBids,_defineProperty({},d.slotID,c.slotBids[d.slotID].map(function(a){if(_checkAllPossibleBidCacheIds(a,d.bidID,d.dealId)){var b={bidState:d.bidState};return d.bidState===BID_STATES.rendered?b.renderTime=Date.now():d.bidState===BID_STATES.set&&(b.setAtTimes=a.hasOwnProperty("setAtTime")?[].concat(_toConsumableArray(a.setAtTimes),[Date.now()]):[Date.now()]),_extends({},a,b)}return a})))});case"STORE_IMPRESSION_DOC_REF":return _extends({},c,{slotBids:_extends({},c.slotBids,_defineProperty({},d.slotID,c.slotBids[d.slotID].map(function(a){return _checkAllPossibleBidCacheIds(a,d.bidID,d.dealId)?_extends({},a,{doc:d.doc}):a})))});case"NO_BID_ON_DFP_SLOTS":return _extends({},c,{DFP:_extends({},c.DFP,{noBidSlotIDs:c.DFP.noBidSlotIDs.concat(d.slotIDs)})});case"REQUESTED_BID_FOR_DFP_SLOTS":return _extends({},c,{DFP:_extends({},c.DFP,{noBidSlotIDs:c.DFP.noBidSlotIDs.filter(function(a){return _inArray(d.slotIDs,a)})})});case"SET_CFG":return _extends({},c,{cfg:d.cfg});case"SHOULD_SAMPLE_LATENCY":return _extends({},c,{shouldSampleLatency:_shouldSample(LATENCY_SAMPLING_RATE)});case"SHOULD_CHUNK_REQUESTS":return c.shouldSampleLatency&&CHUNK_BID_REQUESTS_PROPORTION&&!c.experiments.hasOwnProperty("chunkRequests")?_extends({},c,{experiments:_extends({},c.experiments,{chunkRequests:_shouldSample(CHUNK_BID_REQUESTS_PROPORTION)})}):c;case"RECORD_ORIGINAL_BID_CONFIG":return _extends({},c,{bidConfigs:_extends({},c.bidConfigs,_defineProperty({},d.bidConfig.bidReqID,d.bidConfig))});case"SLOT_IMP_CHANGE":return _extends({},c,{curSlotImps:_extends({},c.curSlotImps,_defineProperty({},d.slotID,{iid:d.iid,ts:d.ts,slotRendered:!1}))});case"SLOT_RENDERED":return _extends({},c,{curSlotImps:_extends({},c.curSlotImps,_defineProperty({},d.slotID,_extends({},c.curSlotImps[d.slotID],{slotRendered:!0})))});case"SET_DFP_VIEWABILITY_PROPERTY":return _extends({},c,{curDFPViewability:_extends({},c.curDFPViewability,_defineProperty({},d.slotID,_extends({},c.curDFPViewability[d.slotID],_defineProperty({},d.prop,d.val))))});case"SAVE_DFP_VIEWABILITY":return _extends({},c,{allDFPViewability:[].concat(_toConsumableArray(c.allDFPViewability),[_extends({},c.curDFPViewability[d.slotID],{slotID:d.slotID})]),curDFPViewability:_extends({},c.curDFPViewability,_defineProperty({},d.slotID,{}))});case"UPDATE_TEST":return _extends({},c,{tests:_extends({},c.tests,_defineProperty({},d.id,{name:d.name,status:d.status,"case":d["case"]}))});default:return c}},reduxDebuggerPresent=debugCheck&&_safeWindowHasOwnProperty("__REDUX_DEVTOOLS_EXTENSION__")?!0:null;reduxDebuggerPresent&&(store=window.__REDUX_DEVTOOLS_EXTENSION__(reducer),store.subscribe(function(){state=store.getState()})),dispatch=function(a){reduxDebuggerPresent?store.dispatch(a):state=reducer(state,a)},dispatch({type:"NOOP"}),function(){var a,b;lsPresent&&(a=localStorage.getItem(CFG_LOCAL_STORAGE_KEY),a&&"undefined"!==a&&(b=JSON.parse(a),dispatch({type:"SET_CFG",cfg:b})))}(),DEFAULT_AAX_HOST=state.cfg.DEFAULT_AAX_HOST||"aax.amazon-adsystem.com",CSM_JS=state.cfg.CSM_JS||"//c.amazon-adsystem.com/aax2/csm.js.gz",CHUNK_BID_REQUESTS_PROPORTION=state.cfg.CHUNK_BID_REQUESTS_PROPORTION,DEBUG_APP_HTML=state.cfg.DEBUG_APP_HTML||"//c.amazon-adsystem.com/aax2/debugApp.html",DEFAULT_TIMEOUT=state.cfg.DEFAULT_TIMEOUT||2e3,DTB_PATH=state.cfg.DTB_PATH||"/e/dtb",PIXEL_PATH=state.cfg.PIXEL_PATH||"/x/px/",LATENCY_SAMPLING_RATE=state.cfg.LATENCY_SAMPLING_RATE||1,COOKIE_MATCH_DELAY=state.cfg.COOKIE_MATCH_DELAY||0,MAX_SLOTS_PER_REQUEST=state.cfg.MAX_SLOTS_PER_REQUEST||1,metrics=function(){var a={},b=Date.now(),c=0,d=function(){var a,b=decodeURIComponent(_getReferrerURL());return a=b.indexOf("://")>-1?b.split("/")[2]:b.split("/")[0],a=a.split(":")[0]},e=function(c,d){d||(d=Date.now()),a[c]=d-b},f=function(b,c){a[b]=c},g=function(e,f){e||(e=5e3),f||(f="PH"),f+="/",setTimeout(function(){a.i=c,a.t0=b,a.site=d();var e=_nonBidCacheIDPixelSrc(a);_pixel(e),a={},b=Date.now(),c++},e)};return{addTimer:e,set:f,schedule:g}}(),pixeling={noBidCacheIDPixel:function(a){return _pixel(_nonBidCacheIDPixelSrc(a))}},utils={shouldSample:_shouldSample,getRandomArrayElement:function(a){return _shuffleArray(a)[0]},getRand:_getRnd},redux={dispatch:dispatch},metrics.addTimer("tlt");try{Object.prototype.hasOwnProperty.call(window,"apstag")&&Object.prototype.hasOwnProperty.call(window.apstag,"_Q")&&window.apstag._Q.length>0&&dispatch({type:"SET_Q",Q:window.apstag._Q})}catch(e){_reportErrorSimple(e,"__error-storeApstagQ__")}window.apstag=function(){var a={punt:_punt,init:_init,debug:_debug,targetingKeys:_targetingKeys,fetchBids:_fetchBids,setDisplayBids:_setDisplayBids,renderImp:_renderImp,bids:_bids};return debugConsole&&(Object.keys(a).forEach(function(b){a[b]=_proxyMethod(b,a[b])}),_fetchDebugHTML()),Object.keys(a).forEach(function(b){a[b]=_addErrorHandlingToMethod(a[b])}),a}(),function(){try{dispatch({type:"SHOULD_SAMPLE_LATENCY"}),state.shouldSampleLatency&&(_sendInitLatencyPixel(),_sendBidsSetOnDFPPixel(),_trackDFPViewabilityPixel())}catch(a){_reportErrorSimple(a,"__error-sampleLatency__")}try{_QHandler()}catch(a){_reportErrorSimple(a,"__error-doLast__")}}()}()}catch(e){_reportError(e,"__error-global__")}}();